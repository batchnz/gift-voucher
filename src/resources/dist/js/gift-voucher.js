!function($){void 0===Craft.GiftVoucher&&(Craft.GiftVoucher={});var e="verbb\\giftvoucher\\elements\\Voucher";Craft.GiftVoucher.VoucherIndex=Craft.BaseElementIndex.extend({editableVoucherTypes:null,$newVoucherBtnVoucherType:null,$newVoucherBtn:null,init:function(e,t,r){this.on("selectSource",$.proxy(this,"updateButton")),this.on("selectSite",$.proxy(this,"updateButton")),this.base(e,t,r)},afterInit:function(){this.editableVoucherTypes=[];for(var e=0;e<Craft.GiftVoucher.editableVoucherTypes.length;e++){var t=Craft.GiftVoucher.editableVoucherTypes[e];this.getSourceByKey("voucherType:"+t.id)&&this.editableVoucherTypes.push(t)}this.base()},getDefaultSourceKey:function(){if("index"===this.settings.context&&"undefined"!=typeof defaultVoucherTypeHandle)for(var e=0;e<this.$sources.length;e++){var t=$(this.$sources[e]);if(t.data("handle")===defaultVoucherTypeHandle)return t.data("key")}return this.base()},updateButton:function(){if(this.$source){var e=this.$source.data("handle"),t,r,i;if(this.editableVoucherTypes.length){var n,o;if(this.$newVoucherBtnVoucherType&&this.$newVoucherBtnVoucherType.remove(),e)for(t=0;t<this.editableVoucherTypes.length;t++)if(this.editableVoucherTypes[t].handle===e){n=this.editableVoucherTypes[t];break}if(this.$newVoucherBtnVoucherType=$('<div class="btngroup submit"/>'),n?(r=this._getVoucherTypeTriggerHref(n),i="index"===this.settings.context?Craft.t("gift-voucher","New voucher"):Craft.t("gift-voucher","New {voucherType} voucher",{voucherType:n.name}),this.$newVoucherBtn=$('<a class="btn submit add icon" '+r+">"+Craft.escapeHtml(i)+"</a>").appendTo(this.$newVoucherBtnVoucherType),"index"!==this.settings.context&&this.addListener(this.$newVoucherBtn,"click",(function(e){this._openCreateVoucherModal(e.currentTarget.getAttribute("data-id"))})),this.editableVoucherTypes.length>1&&(o=$('<div class="btn submit menubtn"></div>').appendTo(this.$newVoucherBtnVoucherType))):this.$newVoucherBtn=o=$('<div class="btn submit add icon menubtn">'+Craft.t("gift-voucher","New voucher")+"</div>").appendTo(this.$newVoucherBtnVoucherType),o){for(var s='<div class="menu"><ul>',t=0;t<this.editableVoucherTypes.length;t++){var a=this.editableVoucherTypes[t];"index"!==this.settings.context&&a===n||(r=this._getVoucherTypeTriggerHref(a),i="index"===this.settings.context?a.name:Craft.t("gift-voucher","New {voucherType} voucher",{voucherType:a.name}),s+="<li><a "+r+'">'+Craft.escapeHtml(i)+"</a></li>")}$(s+="</ul></div>").appendTo(this.$newVoucherBtnVoucherType);var h=new Garnish.MenuBtn(o);"index"!==this.settings.context&&h.on("optionSelect",$.proxy((function(e){this._openCreateVoucherModal(e.option.getAttribute("data-id"))}),this))}this.addButton(this.$newVoucherBtnVoucherType)}if("index"===this.settings.context&&"undefined"!=typeof history){var c="gift-voucher/vouchers";e&&(c+="/"+e),history.replaceState({},"",Craft.getUrl(c))}}},_getVoucherTypeTriggerHref:function(e){if("index"===this.settings.context){var t="gift-voucher/vouchers/"+e.handle+"/new";if(this.siteId&&this.siteId!=Craft.primarySiteId)for(var r=0;r<Craft.sites.length;r++)Craft.sites[r].id==this.siteId&&(t+="/"+Craft.sites[r].handle);return'href="'+Craft.getUrl(t)+'"'}return'data-id="'+e.id+'"'},_openCreateVoucherModal:function(t){if(!this.$newVoucherBtn.hasClass("loading")){for(var r,i=0;i<this.editableVoucherTypes.length;i++)if(this.editableVoucherTypes[i].id===t){r=this.editableVoucherTypes[i];break}if(r){this.$newVoucherBtn.addClass("inactive");var n=this.$newVoucherBtn.text();this.$newVoucherBtn.text(Craft.t("gift-voucher","New {voucherType} voucher",{voucherType:r.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newVoucherBtnGroup,elementType:e,siteId:this.siteId,attributes:{typeId:t},onBeginLoading:$.proxy((function(){this.$newVoucherBtn.addClass("loading")}),this),onEndLoading:$.proxy((function(){this.$newVoucherBtn.removeClass("loading")}),this),onHideHud:$.proxy((function(){this.$newVoucherBtn.removeClass("inactive").text(n)}),this),onSaveElement:$.proxy((function(e){var r="voucherType:"+t;this.sourceKey!==r&&this.selectSourceByKey(r),this.selectElementAfterUpdate(e.id),this.updateElements()}),this)})}}}}),Craft.registerElementIndexClass(e,Craft.GiftVoucher.VoucherIndex)}(jQuery),function($){void 0===Craft.GiftVoucher&&(Craft.GiftVoucher={});var e="verbb\\giftvoucher\\elements\\Code";Craft.GiftVoucher.CodeIndex=Craft.BaseElementIndex.extend({afterInit:function(){var e='href="'+Craft.getUrl("gift-voucher/codes/new")+'"',t=Craft.t("gift-voucher","New code");this.$newProductBtnGroup=$('<div class="btngroup submit"/>'),this.$newProductBtn=$('<a class="btn submit add icon" '+e+">"+t+"</a>").appendTo(this.$newProductBtnGroup),this.addButton(this.$newProductBtnGroup),this.base()}});try{Craft.registerElementIndexClass(e,Craft.GiftVoucher.CodeIndex)}catch(e){}}(jQuery),void 0===Craft.GiftVoucher&&(Craft.GiftVoucher={}),function($){Craft.GiftVoucher.CpAddVoucher=Garnish.Base.extend({orderNumber:null,init:function(e){this.orderNumber=e;var t=$('.menubtn[data-icon="settings"]').data("menubtn");if(t){var r=$('<li><a data-action="gift-vouchers">'+Craft.t("gift-voucher","Manage gift vouchers")+"</a></li>");t.menu.addOptions(r.children()),r.prependTo(t.menu.$container.children().first()),t.menu.on("optionselect",$.proxy(this,"_handleMenuBtn"))}},_handleMenuBtn:function(e){var t;"gift-vouchers"==$(e.selectedOption).data("action")&&new Craft.GiftVoucher.GiftVouchersModal}}),Craft.GiftVoucher.GiftVouchersModal=Garnish.Modal.extend({init:function(){this.$form=$('<form class="modal fitted gift-voucher-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var e=$('<div class="footer"/>').appendTo(this.$form),t=$('<div class="buttons right"/>').appendTo(e);this.$cancelBtn=$('<input type="button" class="btn cancel" value="'+Craft.t("gift-voucher","Cancel")+'"/>').appendTo(t),this.$saveBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("gift-voucher","Add voucher code")+'"/>').appendTo(t),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(e),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$saveBtn,"click","onSubmit"),this.base(this.$form);var r={orderId:this.getOrderId()};Craft.sendActionRequest("POST","gift-voucher/vouchers/get-modal-body",{data:r}).then((e=>{this.$body.html(e.data.html)})),$(this.$form).on("click","[data-code]",$.proxy(this.removeCode,this))},onFadeOut(){this.$form.remove(),this.$shade.remove()},getOrderId(){var e=window.location.pathname.split("/");return e[e.length-1]},removeCode:function(e){e.preventDefault();var t={voucherCode:e.currentTarget.getAttribute("data-code"),orderId:this.getOrderId()};this.$footerSpinner.removeClass("hidden"),Craft.sendActionRequest("POST","gift-voucher/cart/remove-code",{data:t}).then((e=>{e.data.success?(Craft.cp.displayNotice(Craft.t("gift-voucher","Voucher code removed.")),this.onFadeOut()):(Craft.cp.displayError(e.data.error),this.$footerSpinner.addClass("hidden"))}))},onSubmit:function(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","gift-voucher/cart/add-code",{data:t}).then((e=>{this.$footerSpinner.addClass("hidden"),e.data.success?(Craft.cp.displayNotice(Craft.t("gift-voucher","Voucher code applied.")),this.onFadeOut()):(Craft.cp.displayError(e.data.error),this.$footerSpinner.addClass("hidden"))}))}})}(jQuery);
//# sourceMappingURL=gift-voucher.js.map